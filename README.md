# Pixiv 自動下載工具

> 從 Pixiv 獲取每日排行榜圖片並自動下載(支援多種篩選條件)

### 安裝依賴
```bash
npm install
```

## Cookie 設定(僅需一次)

原先透過在 lib/config.js 輸入帳號密碼自動取得 cookie 的方式似乎已停用，無法取得 public 權限。

### 新的 Cookie 獲取方式：
1. 下載電腦瀏覽器擴充功能 (如 Cookie-Editor https://chromewebstore.google.com/detail/hlkenndednhfkekhgcdicdfddnkalmdm?utm_source=item-share-cb) 
2. 登入網頁版 Pixiv 後在右上角擴充功能拼圖中，點擊 Cookie Editor 圖標 
2. 依序點擊 This site -> 允許 -> Export -> json 即完成複製 (約200行，包含 domain,expirationDate等訊息)
2. 在專案根目錄建立 `cookie/pixiv.txt`
2. 在 `cookie/pixiv.txt` 檔案中貼上 Cookie 內容

## 使用方法

### 測試之執行指令
1. **必須先進入到此專案資料夾中執行**
```bash
cd download-picture
```
2. 貼上下方的指令等待約1分鐘，執行期間觀察是否有輸出如: `[20250726/1] 133074580 DL` 等信息
```bash
node index.js 20250726 --pages=6 --tag=女の子,オリジナル --block=スク水,地雷系 --block-group=[巨乳,自撮り]
```
3. 執行完成後進入"女の子_20250726"資料夾，檢查裡面是否有69個項目(67張圖片)
3. 再進入"_black"資料夾中檢查是否有5張圖片
- 133098384.png
- 133148911.png
- 133094526.png
- 133074546.jpg
- 133074487.jpg
### 常用範例

#### 下載指定日期
```bash
node index.js 20240315
```

#### 下載整月數據
```bash
node index.js --month=202403
```

#### 下載整年數據
```bash
node index.js --year=2024
```

#### 帶篩選條件的下載
```bash
node index.js --year=2024 --pages=10 --all --tool `
--tag=想要的tag1,想要的tag2 `
--block=不想要的tag1,不想要的tag2 `
--noword=不想要的word1,不想要的word2
```
- 會下載到picture資料夾中
- " `"是告訴vsxode終端機在同一行的符號(前面要有空格，cmd則是 ^)
- tag和tag之間用逗號分隔，但不能有空白(可從輸出檢查有無生效，記得刪除複製來的逗號前的空白)
## 指令參數詳解


### 基本設定
- **`--max=數量`**: 限制下載數量上限
- **`--pages=頁數`**: 指定下載頁數 (每頁約 50 張)
  - 例如: `--pages=5` 會下載前 250 張圖片 (排行榜前 50%)
- **`--interval=毫秒`**: 設定請求間隔時間 (預設: 10ms)
- **`--orientation=方向`**: 篩選圖片方向 ( landscape：橫向 desktop：電腦螢幕比例 portrait：直向square：正方形)
- **`--type=類型`**: 篩選作品類型 (`all`)
- **`--mode=模式`**: 排行榜類型 (`daily`, `weekly`, `monthly`)


### 篩選參數

#### 標籤篩選
- **`--tag=標籤1,標籤2`**: 必須包含的標籤 (OR 邏輯，須完全相同)
- **`--block=標籤1,標籤2`**: 排除的標籤 (黑名單)
- **`--noword=關鍵字1,關鍵字2`**: 排除含有特定關鍵字的作品 (不須完全相同)

#### 高級篩選
- **`--block-group="[標籤A,標籤B],[標籤C,標籤D]"`**: AND 群組黑名單
  - 當作品同時包含群組內所有標籤時才會被排除
- **`--block-group="[標籤A,標籤B)"`**: 條件式黑名單
  - 如果作品有 標籤A，則必須也有 標籤B，否則會被排除

### 功能開關
- **`--one`**: 僅下載多圖作品的第一張圖片
- **`--all`**: 下載所有圖片 (包括多圖作品的所有頁面)
- **`--nomanga`**: 檢查是否長和寬相差很多(超過10倍)

## 下載規則與命名

### 資料夾結構
```
picture/
├── [第一個tag]_YYYYMMDD/     # 單日下載
├── [第一個tag]_YYYYMM/       # 整月下載  
├── [第一個tag]_YYYY/         # 整年下載
└── black/                    # 被篩選掉的圖片
```

### 命名規則
- `圖片ID.jpg or .png`
- ID前面加 `https://www.pixiv.net/artworks/`就是圖片source
- 日期/後面的數字是下載的頁數

### 下載順序
- 按照排行榜順序依序下載
- 先請求 API 獲取圖片列表，再開始下載圖片
- 每個請求都會檢查是否已存在，避免重複下載，但隔日同圖片會因檔名相同而覆蓋

## 錯誤處理

### HTTP-Other 錯誤
**原因**: Rate Limiting (頻率限制) 或需要登入查看
- 大多數情況是年齡限制內容，需要 Premium 帳戶
- 會自動跳過並在 JSON 檔案中標記為 `state: "fail"`

### Rate Limiting 機制
- **目前設定**: 每 50 個請求休息 8 秒鐘
- **請求計算**: 
  - 下載一張圖片 = 2 個請求
  - 請求 JSON 資料 = 1 個請求
- **經驗推測**: 限制半個小時內的總下載次數

### Cookie 過期或被封鎖
**症狀**: 大量下載失敗或被提示未登入
**解決方法**:
1. 重新從瀏覽器複製 Cookie
2. 貼上到 `cookie/pixiv.txt`
3. 無需更換帳號

**預防措施**: 
- 當偵測到限制下載(HTTP 429)時，程式會自動停止繼續下載
- 避免觸發上面的封鎖

## Tag 管理系統

### tag.txt 檔案功能
每個下載資料夾都會產生 `tag.txt` 檔案，記錄：
- 圖片 ID 對應的所有標籤
- 用於後續標籤分析和管理

### 處理不喜歡的圖片
1. 複製不喜歡的圖片檔名
2. 在 `tag.txt` 中使用 `Ctrl+F` 搜尋該圖片
3. 查看該圖片的所有標籤
4. 將不喜歡的標籤加入到 `--block` 參數中

### Black 資料夾功能
- 存放被篩選條件排除的圖片，可直接從 black 資料夾複製圖片到主資料夾
- `tag.txt` 記錄被排除的原因，如果發現誤判，可以調整篩選條件
  

### 重複檢查機制
即使 JSON 中標示為 "finish"，程式仍會：
1. 檢查資料夾中是否存在 `tag.txt`
2. 比對已下載的圖片 ID
3. 跳過已存在的圖片，只下載新圖片
所以僅是記錄他曾被下載過

## 注意事項

### 效能調整
- **休息時間及權重**: 可根據使用狀況調整，目前設定可能過於保守
- **記憶體需求**: 大量下載時會用到約2GB的記憶體

### 速度太慢
1. 可以嘗試把程式改成下載這個月之前，先查看json(若沒有先請求)篩選出已出現在兩個txt中並且statue不是fail的圖片，再分別下載這些圖片
2. 一次請求一個月中所有API → 並行下載，確認下載完成再請求下一月
3. 刪除程式當中AI生成的無用功能

### 推薦的TAG
1. 較冷門圖片: `--block=diaper,はいてな,腹肉,ぽっちゃり,bbw,SSBBW,肥満化,腹ワイパー,thicc,異形進化,髪行類,多脚ヤンヨ,ショタ,たくしあげ,へそ,腹筋,おちんちん,ルカメイ,男の子,創作男子,青年 `
2. 較不雅圖片: `--block=極上の乳,爆乳,巨乳,淫乳,みっぱい,おっぱい,魅惑の谷間,褐色むちむち,パンチラ,縞パン,ぱんつ,縞ビキニ,泥酔,お品書き,その後の続きを全裸待機,露出,女装,メスガキ,オスガキ `
3. 較商業圖片: `Abdl,夏亞專用機,Among Us,AMOGUS,薬屋,勝利の女神,BlueArchive,原神,新作予告,新刊`